[workspace]
members = [
    # lp-app workspace members
    "lp-app/crates/lp-engine",
    "lp-app/crates/lp-engine-client",
    "lp-app/crates/lp-shared",
    "lp-app/crates/lp-server",
    "lp-app/apps/lp-cli",
    "lp-app/crates/lp-model",
    # lp-glsl workspace members
    "lp-glsl/crates/lp-builtins",
    "lp-glsl/crates/lp-filetests-gen",
    "lp-glsl/crates/lp-glsl-compiler",
    "lp-glsl/crates/lp-glsl-filetests",
    "lp-glsl/crates/lp-jit-util",
    "lp-glsl/crates/lp-riscv-shared",
    "lp-glsl/crates/lp-riscv-tools",
    "lp-glsl/apps/lp-builtin-gen",
    "lp-glsl/apps/lp-builtins-app",
    "lp-glsl/apps/lp-test",
    "lp-glsl/apps/esp32-glsl-jit",
]
resolver = "2"

# Exclude lp-builtins-app and esp32-glsl-jit from default workspace builds (they're no_std, only build for RISC-V)
# They're still in workspace members so they can use workspace dependencies
# Build them explicitly with: just build-builtins or just esp32-build
default-members = [
    # lp-app workspace members
    "lp-app/crates/lp-engine",
    "lp-app/crates/lp-engine-client",
    "lp-app/crates/lp-shared",
    "lp-app/crates/lp-server",
    "lp-app/apps/lp-cli",
    "lp-app/crates/lp-model",
    # lp-glsl workspace members (excluding lp-builtins-app)
    "lp-glsl/crates/lp-builtins",
    "lp-glsl/crates/lp-filetests-gen",
    "lp-glsl/crates/lp-glsl-compiler",
    "lp-glsl/crates/lp-glsl-filetests",
    "lp-glsl/crates/lp-jit-util",
    "lp-glsl/crates/lp-riscv-shared",
    "lp-glsl/crates/lp-riscv-tools",
    "lp-glsl/apps/lp-builtin-gen",
    "lp-glsl/apps/lp-test",
]

[workspace.package]
version = "40.0.0"
authors = ["The Wasmtime Project Developers"]
edition = "2024"
license = "Apache-2.0 WITH LLVM-exception"
rust-version = "1.90.0"

[workspace.lints.rust]
unused_extern_crates = 'warn'
trivial_numeric_casts = 'warn'
unstable_features = 'warn'
unused_import_braces = 'warn'
unused-lifetimes = 'warn'
unused-macro-rules = 'warn'

[workspace.lints.clippy]
all = { level = 'allow', priority = -1 }
clone_on_copy = 'warn'
map_clone = 'warn'
uninlined_format_args = 'warn'
unnecessary_to_owned = 'warn'
manual_strip = 'warn'
useless_conversion = 'warn'
unnecessary_mut_passed = 'warn'
unnecessary_fallible_conversions = 'warn'
unnecessary_cast = 'warn'
allow_attributes_without_reason = 'warn'
from_over_into = 'warn'
redundant_field_names = 'warn'
multiple_bound_locations = 'warn'
extra_unused_type_parameters = 'warn'

[workspace.dependencies]
# Cranelift crates - git dependencies
cranelift-codegen = { git = "https://github.com/Yona-Appletree/lp-cranelift.git", branch = "feature/lp2025", version = "0.127.0", default-features = false }
cranelift-frontend = { git = "https://github.com/Yona-Appletree/lp-cranelift.git", branch = "feature/lp2025", version = "0.127.0", default-features = false }
cranelift-module = { git = "https://github.com/Yona-Appletree/lp-cranelift.git", branch = "feature/lp2025", version = "0.127.0", default-features = false }
cranelift-jit = { git = "https://github.com/Yona-Appletree/lp-cranelift.git", branch = "feature/lp2025", version = "0.127.0", default-features = false }
cranelift-native = { git = "https://github.com/Yona-Appletree/lp-cranelift.git", branch = "feature/lp2025", version = "0.127.0" }
cranelift-object = { git = "https://github.com/Yona-Appletree/lp-cranelift.git", branch = "feature/lp2025", version = "0.127.0" }
cranelift-reader = { git = "https://github.com/Yona-Appletree/lp-cranelift.git", branch = "feature/lp2025", version = "0.127.0" }
cranelift-control = { git = "https://github.com/Yona-Appletree/lp-cranelift.git", branch = "feature/lp2025", version = "0.127.0", default-features = false }
cranelift-interpreter = { git = "https://github.com/Yona-Appletree/lp-cranelift.git", branch = "feature/lp2025", version = "0.127.0" }

# Common dependencies
target-lexicon = "0.13.0"
hashbrown = { version = "0.15", default-features = false, features = ["alloc", "default-hasher"] }
anyhow = { version = "1.0.100", default-features = false }
log = { version = "0.4", default-features = false }
regex = "1.9.1"
glob = "0.3.3"
object = { version = "0.37.3", default-features = false, features = ['read_core', 'elf'] }
critical-section = { version = "1.2.0", default-features = false }
serde = { version = "1.0.228", default-features = false, features = ["alloc"] }
serde_json = { version = "1.0.80", default-features = false, features = ["alloc"] }

[profile.release]
# Link-time optimization for all release builds - saves ~100-300 KB
# This applies to all packages in the workspace
lto = true

# ESP32 app release profile optimizations (embedded target)
[profile.release.package.esp32-glsl-jit]
# Strip debuginfo but keep symbols (needed for defmt/probe-rs) - saves ~1-1.5 MB
strip = "debuginfo"
# Optimize for size instead of speed - saves ~200-500 KB
opt-level = "z"
# Single codegen unit for better dead code elimination - saves ~50-100 KB
codegen-units = 1
# Note: lto is inherited from workspace [profile.release]
