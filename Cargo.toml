[workspace]
members = [
    # lp-app workspace members
    "lp-core/lp-engine",
    "lp-core/lp-engine-client",
    "lp-core/lp-shared",
    "lp-core/lp-server",
    "lp-core/lp-client",
    "lp-fw/fw-core",
    "lp-cli",
    "lp-fw/fw-esp32",
    "lp-fw/fw-emu",
    "lp-fw/fw-tests",
    "lp-core/lp-model",
    # lp-glsl workspace members
    "lp-glsl/lp-glsl-builtins",
    "lp-glsl/lp-glsl-filetests-gen-app",
    "lp-glsl/lp-glsl-compiler",
    "lp-glsl/lp-glsl-filetests",
    "lp-glsl/lp-glsl-jit-util",
    "lp-riscv/lp-riscv-emu-shared",
    "lp-riscv/lp-riscv-inst",
    "lp-riscv/lp-riscv-emu",
    "lp-riscv/lp-riscv-elf",
    "lp-riscv/lp-riscv-emu-guest",
    "lp-riscv/lp-riscv-emu-guest-test-app",
    "lp-glsl/lp-glsl-builtins-gen-app",
    "lp-glsl/lp-glsl-builtins-emu-app",
    "lp-glsl/lp-glsl-filetests-app",
    "lp-glsl/esp32-glsl-jit",
    "lp-glsl/lp-glsl-q32-metrics-app",
]
resolver = "2"

# Exclude lp-glsl-builtins-emu-app, esp32-glsl-jit, and fw-esp32 from default workspace builds (they're no_std, only build for RISC-V)
# They're still in workspace members so they can use workspace dependencies
# Build them explicitly with: just build-builtins, just build-rv32, or just build-fw-esp32
default-members = [
    # lp-app workspace members
    "lp-core/lp-engine",
    "lp-core/lp-engine-client",
    "lp-core/lp-shared",
    "lp-core/lp-server",
    "lp-core/lp-client",
    "lp-fw/fw-core",
    "lp-cli",
    "lp-core/lp-model",
    # lp-glsl workspace members (excluding lp-glsl-builtins-emu-app)
    "lp-glsl/lp-glsl-builtins",
    "lp-glsl/lp-glsl-filetests-gen-app",
    "lp-glsl/lp-glsl-compiler",
    "lp-glsl/lp-glsl-filetests",
    "lp-glsl/lp-glsl-jit-util",
    "lp-riscv/lp-riscv-emu-shared",
    "lp-riscv/lp-riscv-inst",
    "lp-riscv/lp-riscv-emu",
    "lp-riscv/lp-riscv-elf",
    "lp-glsl/lp-glsl-builtins-gen-app",
    "lp-glsl/lp-glsl-filetests-app",
    "lp-glsl/lp-glsl-q32-metrics-app",
]
[workspace.package]
version = "40.0.0"
authors = ["The Wasmtime Project Developers"]
edition = "2024"
license = "Apache-2.0 WITH LLVM-exception"
rust-version = "1.90.0"

[workspace.lints.rust]
unused_extern_crates = 'warn'
trivial_numeric_casts = 'warn'
unstable_features = 'warn'
unused_import_braces = 'warn'
unused-lifetimes = 'warn'
unused-macro-rules = 'warn'

[workspace.lints.clippy]
all = { level = 'allow', priority = -1 }
clone_on_copy = 'warn'
map_clone = 'warn'
uninlined_format_args = 'warn'
unnecessary_to_owned = 'warn'
manual_strip = 'warn'
useless_conversion = 'warn'
unnecessary_mut_passed = 'warn'
unnecessary_fallible_conversions = 'warn'
unnecessary_cast = 'warn'
allow_attributes_without_reason = 'warn'
from_over_into = 'warn'
redundant_field_names = 'warn'
multiple_bound_locations = 'warn'
extra_unused_type_parameters = 'warn'

[workspace.dependencies]
# Logging dependencies
test-log = "0.2"
env_logger = "0.11"

# Cranelift crates - git dependencies
cranelift-codegen = { git = "https://github.com/light-player/lp-cranelift.git", branch = "feature/lp2025", version = "0.127.0", default-features = false }
cranelift-frontend = { git = "https://github.com/light-player/lp-cranelift.git", branch = "feature/lp2025", version = "0.127.0", default-features = false }
cranelift-module = { git = "https://github.com/light-player/lp-cranelift.git", branch = "feature/lp2025", version = "0.127.0", default-features = false }
cranelift-jit = { git = "https://github.com/light-player/lp-cranelift.git", branch = "feature/lp2025", version = "0.127.0", default-features = false }
cranelift-native = { git = "https://github.com/light-player/lp-cranelift.git", branch = "feature/lp2025", version = "0.127.0" }
cranelift-object = { git = "https://github.com/light-player/lp-cranelift.git", branch = "feature/lp2025", version = "0.127.0" }
cranelift-reader = { git = "https://github.com/light-player/lp-cranelift.git", branch = "feature/lp2025", version = "0.127.0" }
cranelift-control = { git = "https://github.com/light-player/lp-cranelift.git", branch = "feature/lp2025", version = "0.127.0", default-features = false }
cranelift-interpreter = { git = "https://github.com/light-player/lp-cranelift.git", branch = "feature/lp2025", version = "0.127.0" }

# Cranelift crates - path dependencies
# cranelift-codegen = { path = "../feature/lp-cranelift-lp2025/cranelift/codegen", default-features = false }
# cranelift-frontend = { path = "../feature/lp-cranelift-lp2025/cranelift/frontend", default-features = false }
# cranelift-module = { path = "../feature/lp-cranelift-lp2025/cranelift/module", default-features = false }
# cranelift-jit = { path = "../feature/lp-cranelift-lp2025/cranelift/jit", default-features = false }
# cranelift-native = { path = "../feature/lp-cranelift-lp2025/cranelift/native" }
# cranelift-object = { path = "../feature/lp-cranelift-lp2025/cranelift/object" }
# cranelift-reader = { path = "../feature/lp-cranelift-lp2025/cranelift/reader" }
# cranelift-control = { path = "../feature/lp-cranelift-lp2025/cranelift/control", default-features = false }
# cranelift-interpreter = { path = "../feature/lp-cranelift-lp2025/cranelift/interpreter" }

# regalloc2 - local fork (for feature-gating ION allocator)
# regalloc2 = { version = "0.13.5" }
regalloc2 = { path = "../lp-regalloc2", default-features = false, features = ["std"] }

# Common dependencies

# Common dependencies
target-lexicon = "0.13.0"
hashbrown = { version = "0.15", default-features = false, features = ["alloc", "default-hasher"] }
anyhow = { version = "1.0.100", default-features = false }
log = { version = "0.4", default-features = false }
regex = "1.9.1"
glob = "0.3.3"
object = { version = "0.37.3", default-features = false, features = ['read_core', 'elf'] }
critical-section = { version = "1.2.0", default-features = false }
serde = { version = "1.0.228", default-features = false, features = ["alloc"] }
serde_json = { version = "1.0.80", default-features = false, features = ["alloc"] }
base64 = { version = "0.22", default-features = false, features = ["alloc"] }

[profile.release]
# Link-time optimization for all release builds - saves ~100-300 KB
# This applies to all packages in the workspace
lto = true
# Optimize all dependencies for size (embedded target)
# Individual packages can override this if needed
opt-level = "z"
codegen-units = 1

# ESP32 app release profile optimizations (embedded target)
[profile.release.package.esp32-glsl-jit]
# Strip debuginfo but keep symbols (needed for defmt/probe-rs) - saves ~1-1.5 MB
strip = "debuginfo"
# Optimize for size instead of speed - saves ~200-500 KB
opt-level = "z"
# Single codegen unit for better dead code elimination - saves ~50-100 KB
codegen-units = 1
# Note: lto is inherited from workspace [profile.release]

# ESP32 firmware release profile optimizations (embedded target)
[profile.release.package.fw-esp32]
# Strip debuginfo but keep symbols (needed for cargo bloat analysis) - saves ~1-1.5 MB
# Set to 'true' for production builds to remove symbols too
strip = "debuginfo"
# strip = true
# Optimize for size instead of speed - saves ~200-500 KB
opt-level = "z"
# Single codegen unit for better dead code elimination - saves ~50-100 KB
codegen-units = 1
# Note: lto is inherited from workspace [profile.release]

# Hot-path crates: optimize for speed instead of size
# These crates are in the critical rendering path and benefit from speed optimizations
[profile.release.package.lp-engine]
# Optimize for speed (hot path in rendering loop)
opt-level = 3
# Keep multiple codegen units for faster compilation and better parallelization
codegen-units = 4
# Note: lto is inherited from workspace [profile.release]

[profile.release.package.lp-glsl-builtins]
# Optimize for speed (hot path in shader execution)
opt-level = 3
# Keep multiple codegen units for faster compilation and better parallelization
codegen-units = 4
# Note: lto is inherited from workspace [profile.release]

# Patch esp-println to use our fork with custom writer support
[patch.crates-io]
esp-println = { path = "lp-fw/esp-println-fork" }
