[package]
name = "esp32-glsl-jit"
version = "0.1.0"
edition = "2021"
license = "MIT OR Apache-2.0"

[[bin]]
name = "esp32-glsl-jit"
path = "src/main.rs"
test = false

[dependencies]
# GLSL compiler for JIT compilation
lp-glsl-compiler = { path = "../../crates/lp-glsl-compiler", default-features = false, features = ["core"] }
glsl = { git = "https://github.com/Yona-Appletree/glsl-parser.git", branch = "feature/spans", default-features = false }

# Cranelift for JIT compilation on ESP32-C3/C6 (RISC-V32)
# Note: Using explicit versions since this package is excluded from workspace
cranelift-codegen = { git = "https://github.com/Yona-Appletree/lp-cranelift.git", branch = "feature/lp2025", version = "0.127.0", default-features = false, features = ["riscv32"] }
cranelift-frontend = { git = "https://github.com/Yona-Appletree/lp-cranelift.git", branch = "feature/lp2025", version = "0.127.0", default-features = false, features = ["core"] }
cranelift-module = { git = "https://github.com/Yona-Appletree/lp-cranelift.git", branch = "feature/lp2025", version = "0.127.0", default-features = false, features = ["core"] }
cranelift-control = { git = "https://github.com/Yona-Appletree/lp-cranelift.git", branch = "feature/lp2025", version = "0.127.0", default-features = false }
target-lexicon = "0.13.0"
hashbrown = { version = "0.15", default-features = false, features = ["alloc", "default-hasher"] }

# ESP32-C6 HAL and runtime
esp-hal = { version = "=1.0.0-rc.0", features = ["defmt", "esp32c6", "unstable"] }
esp-hal-embassy = { version = "0.9.0", features = ["defmt", "esp32c6"] }
esp-alloc = { version = "0.8.0", features = ["defmt"] }
panic-rtt-target = { version = "0.2.0", features = ["defmt"] }
rtt-target = { version = "0.6.1", features = ["defmt"] }
defmt = "1.0.1"
embassy-executor = { version = "0.7.0", features = ["defmt", "task-arena-size-20480"] }
embassy-time = { version = "0.4.0", features = ["defmt"] }
esp-bootloader-esp-idf = { version = "0.2.0", features = ["esp32c6"] }

# Disable unsafe-assume-single-core feature for portable-atomic
# ESP32-C6 supports atomic CAS, so this feature is incompatible
[dependencies.portable-atomic]
version = "1.11"
default-features = false

# Release profile optimizations for embedded target (ESP32-C6)
[profile.release]
# Strip debuginfo but keep symbols (needed for defmt/probe-rs) - saves ~1-1.5 MB
strip = "debuginfo"
# Optimize for size instead of speed - saves ~200-500 KB
opt-level = "z"
# Single codegen unit for better dead code elimination - saves ~50-100 KB
codegen-units = 1
# Link-time optimization - saves ~100-300 KB
lto = true

